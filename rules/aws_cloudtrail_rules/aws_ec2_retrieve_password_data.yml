AnalysisType: rule
Filename: aws_ec2_retrieve_password_data.py
RuleID: "AWS.EC2.RetrievePasswordData"
DisplayName: "EC2 Retrieve Password Data"
Enabled: true
LogTypes:
  - AWS.CloudTrail
Tags:
  - AWS
  - Credential Access
  - Stratus Red Team
Reports:
  MITRE ATT&CK:
    - TA0006:T1552.005 # Unsecured Credentials: Cloud Instance Metadata API 
Severity: Medium
Description: An attacker attempted to retrieve RDP passwords on a high number of Windows EC2 instances.
Runbook: https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_GetPasswordData.html
Reference: https://stratus-red-team.cloud/attack-techniques/AWS/aws.credential-access.ec2-get-password-data/
Threshold: 30
DedupPeriodMinutes: 60
SummaryAttributes:
  - eventName
  - userAgent
  - sourceIpAddress
  - recipientAccountId
  - p_any_aws_arns
Tests:
  - Name: GetPasswordData Denied
    ExpectedResult: true
    Log: {
      "awsRegion": "us-west-2",
      "errorCode": "Client.UnauthorizedOperation",
      "errorMessage": "You are not authorized to perform this operation. User: arn:aws:sts::123123123123:assumed-role/stratus-red-team-ec2-get-password-data-role/aws-go-sdk-1729107121254489000 is not authorized to perform: ec2:GetPasswordData on resource: arn:aws:ec2:us-west-2:123123123123:instance/* because no identity-based policy allows the ec2:GetPasswordData action. Encoded authorization failure message: 0_xXZ6NLm0bgIyx53x42CEgodXIEyIuFkYTNZsfAsCx0Je2cG0SxvtF3FLam_gps4zCpaaG4XYWiHSuguf8RrIcDpt5tMbWUnH5N9-I6vrePX-Z5E1jSH-H7wfEie6aDDay_JG1h0FVO0nmweeyWPWTad70rbpuY5nRuA1x7hl0IchZsCn6FN-JjSexwUdbC0D0FuU_R_9hMEV3GTN1QzQRqv-E-aR7d9abK3t2Yasrk96NEKhBd8i45AjG5xyOIpA2-duLtWu8TcF1Rr-PxHGqNjAOpqzkf5vBabRHJp-_D6JzBby-kmzTg_EVOW1E_S1KrnuwyXUNsgbpHHM5TePAJtpn6sxKRD1sI0HWgdY_REpCq-B-4UknjfHxA2DuNQ04lll3cwYDEG6IipyfypTGkQL_TaksAh02yKmeIvNLvYE-c0s1UAge331CXzzVt166VHjT3N6fD5p1y6nFbB0qmdLk71aOBTwX4erCd4XB-lB4Z4N1WLNXjiRM0ZuCDMkN3AttwA-s0NXbFzt1CGRXmyesK1oLYN0YcaojMUfxem3g70X-MYuKRCizSxb8yhr1P3ME",
      "eventCategory": "Management",
      "eventID": "f3351400-afc7-492f-a920-85987b182ad8",
      "eventName": "GetPasswordData",
      "eventSource": "ec2.amazonaws.com",
      "eventTime": "2024-10-16 19:32:11.000000000",
      "eventType": "AwsApiCall",
      "eventVersion": "1.10",
      "managementEvent": true,
      "readOnly": true,
      "recipientAccountId": "123123123123",
      "requestID": "865da21c-fbce-4a16-a9db-50294df58b04",
      "requestParameters": {
        "instanceId": "i-gavfjo3wx6rbdh9v"
      },
      "sourceIPAddress": "123.123.123.123",
      "tlsDetails": {
        "cipherSuite": "TLS_AES_128_GCM_SHA256",
        "clientProvidedHostHeader": "ec2.us-west-2.amazonaws.com",
        "tlsVersion": "TLSv1.3"
      },
      "userAgent": "stratus-red-team_6b77d925-2d64-4281-b6a3-72c74e44daa3",
      "userIdentity": {
        "accessKeyId": "ASIASXP6SDP2LTWUEQLC",
        "accountId": "123123123123",
        "arn": "arn:aws:sts::123123123123:assumed-role/stratus-red-team-ec2-get-password-data-role/aws-go-sdk-1729107121254489000",
        "principalId": "AROASXP6SDP2DAMHZX6IE:aws-go-sdk-1729107121254489000",
        "sessionContext": {
          "attributes": {
            "creationDate": "2024-10-16T19:32:09Z",
            "mfaAuthenticated": "false"
          },
          "sessionIssuer": {
            "accountId": "123123123123",
            "arn": "arn:aws:iam::123123123123:role/stratus-red-team-ec2-get-password-data-role",
            "principalId": "AROASXP6SDP2DAMHZX6IE",
            "type": "Role",
            "userName": "stratus-red-team-ec2-get-password-data-role"
          }
        },
        "type": "AssumedRole"
      }
    }